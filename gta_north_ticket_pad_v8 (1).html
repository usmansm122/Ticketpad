<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Team GTA North ‚Äì Bundle Maker (All Protectors)</title>
  <style>
    :root {
      --red-main: #c8102e;
      --red-dark: #850018;
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --text-main: #222222;
      --text-muted: #666666;
      --border: #dddddd;
      --accent: #0077b6;
      --radius-lg: 18px;
      --radius-md: 10px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #ffe5e9 0, #f5f5f7 40%, #e9f2ff 100%);
      color: var(--text-main);
    }
    .page-wrap { min-height: 100vh; padding: 24px; display: flex; justify-content: center; }
    .container { width: 100%; max-width: 1350px; }

    .header-card {
      background: linear-gradient(135deg, var(--red-dark), var(--red-main));
      color: #fff;
      border-radius: 24px;
      padding: 20px 24px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      box-shadow: 0 14px 40px rgba(0,0,0,0.25);
    }
    .header-left h1 {
      margin: 0 0 4px 0;
      font-size: 24px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .header-left p { margin: 0; font-size: 13px; opacity: 0.9; }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px 18px 18px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.12);
      border: 1px solid rgba(0,0,0,0.04);
    }
    .card + .card { margin-top: 16px; }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card-header h2 { margin: 0; font-size: 18px; }
    .hint { font-size: 12px; color: var(--text-muted); margin: 0 0 4px 0; }

    .table-wrap { width: 100%; overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 12px;
      min-width: 1150px;
    }
    thead { background: #fafafa; }
    th, td { padding: 6px 5px; text-align: left; border-bottom: 1px solid #eee; }
    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      border-bottom: 1px solid #e0e0e0;
    }
    tbody tr:nth-child(even) { background: #fcfcfc; }

    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 3px 4px;
      font-size: 12px;
      border-radius: var(--radius-md);
      border: 1px solid #d0d0d0;
      outline: none;
      background: #fff;
    }
    input[type="number"] { text-align: right; }
    input[readonly] { background: #f7f7f7; color: #555; }
    select:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0,119,182,0.15);
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .btn-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-primary { background: var(--red-main); color: #fff; }
    .btn-secondary { background: #f0f0f3; color: #333; }
    .btn-danger { background: #ffe7ea; color: #b00020; }
    .btn span.icon { font-size: 14px; }
    .internal-tag {
      font-size: 11px;
      color: var(--red-dark);
      background: #fff1f2;
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid #ffd2da;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 6px;
    }
    .summary-item {
      background: #fafafa;
      border-radius: var(--radius-md);
      padding: 8px 10px;
      border: 1px solid #ebebeb;
    }
    .summary-item label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      display: block;
      margin-bottom: 3px;
    }
    .summary-item .value { font-size: 15px; font-weight: 600; }
    .summary-item .value.accent { color: var(--red-main); }
    .summary-item small {
      display: block;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .footer-note strong { color: var(--red-dark); }

    .footer-made-by {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Catalog search */
    .catalog-search-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .catalog-search-row input {
      width: 260px;
      max-width: 100%;
    }
    .catalog-search-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Customer view */
    .customer-box {
      background: #fafafa;
      border-radius: var(--radius-md);
      padding: 10px 12px;
      border: 1px solid #e2e2e2;
      font-size: 12px;
      white-space: pre-line;
      min-height: 60px;
    }
    .coupon-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px dashed var(--red-main);
      font-size: 12px;
      color: var(--red-dark);
      background: #fff5f6;
      min-width: 120px;
      justify-content: center;
    }

    /* Protection plans overlay */
    .protection-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.60);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 999;
    }
    .protection-panel {
      background: #fff;
      border-radius: 24px;
      max-width: 1100px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px 22px 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .protection-header {
      display:flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .protection-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .protection-header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-muted);
    }
    .protection-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }
    .protect-card {
      border-radius: 18px;
      border: 1px solid #eee;
      padding: 12px 13px 14px;
      background: linear-gradient(145deg,#ffffff,#f7f7f7);
      box-shadow: 0 8px 22px rgba(0,0,0,0.08);
    }
    .protect-card h3 {
      margin: 6px 0 6px;
      font-size: 15px;
    }
    .protect-card ul {
      margin: 0 0 8px 18px;
      padding: 0;
      font-size: 12px;
      color: var(--text-main);
    }
    .protect-card .pill {
      display:inline-block;
      font-size:11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      background: #ffe5ea;
      color: var(--red-dark);
      padding: 3px 9px;
      border-radius: 999px;
    }

    @media (max-width: 900px) {
      .summary-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .header-card { flex-direction: column; align-items: flex-start; gap: 10px; }
      .protection-grid { grid-template-columns: 1fr; }
      .btn-row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="container">
      <div class="header-card">
        <div class="header-left">
          <h1>Team GTA North ‚Äì Bundle Maker</h1>
          <p>Model mattress & protection offers with built-in internal math.</p>
        </div>
      </div>

      <!-- LINE ITEMS -->
      <div class="card">
        <div class="card-header">
          <h2>Line Items</h2>
        </div>
        <p class="hint">
          1) Pick a SKU from the catalog or search below. 2) Size, brand, retail and cost auto-fill. 3) Adjust % off or selling price to test different offers.
        </p>
        <div class="table-wrap">
          <table id="bundle-table">
            <thead>
              <tr>
                <th style="width: 20%;">Catalog item (SKU from sheet)</th>
                <th style="width: 6%;">Size</th>
                <th style="width: 12%;">Brand</th>
                <th style="width: 12%;">Item note</th>
                <th style="width: 9%;">Category</th>
                <th style="width: 8%;">Retail $</th>
                <th style="width: 7%;">Deal %</th>
                <th style="width: 8%;">Selling $</th>
                <th style="width: 8%;">Cost $</th>
                <th style="width: 7%;">GP $</th>
                <th style="width: 7%;">GP %</th>
                <th style="width: 7%;">Comm. $</th>
                <th style="width: 5%;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="btn-row">
          <div class="btn-inline">
            <button class="btn btn-primary" type="button" onclick="addRow()">
              <span class="icon">‚ûï</span> Add blank line
            </button>
            <span class="internal-tag">Internal view only</span>
          </div>
          <button class="btn btn-danger" type="button" onclick="clearAll()">
            <span class="icon">üóëÔ∏è</span> Clear all
          </button>
        </div>
      </div>

      <!-- QUICK CATALOG SEARCH -->
      <div class="card">
        <div class="card-header">
          <h2>Quick Catalog Search</h2>
        </div>
        <p class="hint">
          Internal view ‚Äì search by SKU / brand / size and drop protectors into the bundle.
        </p>
        <div class="catalog-search-row">
          <input
            type="text"
            id="catalog-search-input"
            placeholder="Search Hush, 25HGIMP-3, Q, Malouf‚Ä¶"
            oninput="renderCatalogSearch()"
          />
          <span class="catalog-search-meta">
            Uses the internal CATALOG (not live inventory).
          </span>
        </div>
        <div class="table-wrap" style="max-height: 220px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th>SKU</th>
                <th>Size</th>
                <th>Brand</th>
                <th>Source</th>
                <th>Retail $</th>
                <th>Cost $</th>
                <th style="width: 80px;"></th>
              </tr>
            </thead>
            <tbody id="catalog-search-results"></tbody>
          </table>
        </div>
      </div>

      <!-- BUNDLE SUMMARY (INTERNAL) -->
      <div class="card" style="margin-top: 18px;">
        <div class="card-header">
          <h2>Bundle Summary ‚Äì internal</h2>
        </div>
        <p class="hint">
          Internal summary of this bundle (GP, cost and commission stay on this screen).
        </p>
        <div class="summary-grid">
          <div class="summary-item">
            <label>Total selling</label>
            <div class="value" id="sum-selling">$0.00</div>
            <small>Sum of all line item selling prices</small>
          </div>
          <div class="summary-item">
            <label>Total cost</label>
            <div class="value" id="sum-cost">$0.00</div>
            <small>What we pay (estimate)</small>
          </div>
          <div class="summary-item">
            <label>Total GP</label>
            <div class="value accent" id="sum-gp">$0.00</div>
            <small>Selling ‚àí cost</small>
          </div>
          <div class="summary-item">
            <label>Overall GP %</label>
            <div class="value" id="sum-gp-percent">0.0%</div>
            <small>GP √∑ selling across the whole bundle</small>
          </div>
        </div>
        <div class="summary-grid" style="margin-top: 10px;">
          <div class="summary-item">
            <label>Total commission</label>
            <div class="value accent" id="sum-comm">$0.00</div>
            <small>Auto-calculated based on category</small>
          </div>
          <div class="summary-item">
            <label>Avg commission per $100 sold</label>
            <div class="value" id="sum-comm-per-100">$0.00</div>
            <small>Commission √∑ (selling √∑ 100)</small>
          </div>
          <div class="summary-item">
            <label>Mattress & Extend selling</label>
            <div class="value" id="sum-mattress-extend">$0.00</div>
            <small>Core ticket value</small>
          </div>
          <div class="summary-item">
            <label>Accessories selling</label>
            <div class="value" id="sum-accessories">$0.00</div>
            <small>Protectors, pads, encasements, etc.</small>
          </div>
        </div>

        <div class="footer-note">
          <span><strong>Team GTA North ‚Äì One Region, One Standard.</strong></span>
          <span class="footer-made-by">Made by Moe Shahid ‚Äì GTA North</span>
        </div>
      </div>

      <!-- CUSTOMER VIEW + COUPON -->
      <div class="card">
        <div class="card-header">
          <h2>Customer view & coupon</h2>
          <button class="btn btn-primary" type="button" onclick="refreshCustomerView()">
            <span class="icon">üëÄ</span> Generate customer summary
          </button>
        </div>
        <p class="hint">
          Clean wording you can show or read to the customer. No cost, GP or commission numbers appear here.
        </p>
        <div id="customer-summary-box" class="customer-box">
No priced items yet ‚Äì build a bundle above, then tap ‚ÄúGenerate customer summary‚Äù.
        </div>
        <div class="btn-row" style="margin-top: 12px;">
          <div class="btn-inline">
            <button class="btn btn-secondary" type="button" onclick="generateCouponCode()">
              <span class="icon">üéüÔ∏è</span> Generate coupon code
            </button>
            <span id="coupon-code-display" class="coupon-pill">No code yet</span>
          </div>
          <p class="hint" style="margin: 0;">
            Use the code in your notes/email so you can find this offer again. Code is also copied to your clipboard (where supported).
          </p>
        </div>
      </div>

      <!-- PROTECTION PLANS INTERNAL VIEW -->
      <div class="card">
        <div class="card-header">
          <h2>Protection plans (internal view)</h2>
          <button class="btn btn-secondary" type="button" onclick="openProtectionPlans()">
            <span class="icon">üõ°Ô∏è</span> Open protection plans
          </button>
        </div>
        <p class="hint">
          Internal view only ‚Äì use this to walk the customer through simple Good / Better / Best protection stories, then apply a plan into the bundle.
        </p>
      </div>
    </div>
  </div>

  <!-- OVERLAY FOR PROTECTION PLANS -->
  <div id="protection-overlay" class="protection-overlay">
    <div class="protection-panel">
      <div class="protection-header">
        <div>
          <h2>Protection plans ‚Äì internal view</h2>
          <p>Pick a plan with the customer, then tap ‚ÄúApply to bundle‚Äù to drop the pieces into your calculator.</p>
        </div>
        <button class="btn btn-secondary" type="button" onclick="closeProtectionPlans()">
          ‚Üê Back to bundle
        </button>
      </div>
      <div class="protection-grid">
        <div class="protect-card" data-plan="good">
          <div class="pill">Good</div>
          <h3>Basic spill & mattress cover</h3>
          <ul>
            <li>1√ó Mattress protector ‚Äì Q (Bloom Essentials)</li>
            <li>1√ó Boxspring cover ‚Äì Q (Bloom Boxspring)</li>
            <li>Standard Extend on mattress</li>
          </ul>
          <button class="btn btn-primary" type="button" onclick="applyPlan('good')">
            Apply ‚ÄúGood‚Äù to bundle
          </button>
        </div>
        <div class="protect-card" data-plan="better">
          <div class="pill">Better</div>
          <h3>Upgraded cooling cover</h3>
          <ul>
            <li>1√ó Clima mattress protector ‚Äì Q</li>
            <li>1√ó Hush Graph-Iced mattress protector ‚Äì Q</li>
            <li>Extend ‚Äì Plus coverage on mattress</li>
          </ul>
          <button class="btn btn-primary" type="button" onclick="applyPlan('better')">
            Apply ‚ÄúBetter‚Äù to bundle
          </button>
        </div>
        <div class="protect-card" data-plan="best">
          <div class="pill">Best</div>
          <h3>Triple-Shield premium protection</h3>
          <ul>
            <li>1√ó Hush Triple-Shield protector ‚Äì Q</li>
            <li>1√ó Hush ArchTech protector ‚Äì Q</li>
            <li>Extend ‚Äì Premium coverage on mattress</li>
          </ul>
          <button class="btn btn-primary" type="button" onclick="applyPlan('best')">
            Apply ‚ÄúBest‚Äù to bundle
          </button>
        </div>
      </div>
      <p class="hint" style="margin-top: 12px;">
        This screen is just an internal view. Keep language simple when you mirror it for the customer on the main bundle view.
      </p>
    </div>
  </div>

  <script>
    const COMM_RATES = {
      "mattress": 0.125,
      "extend": 0.125,
      "accessory": 0.18,
      "other": 0.0
    };

    const CATALOG = [
      { sku: "23BECMP-1", size: "T",   cost: 34.00, retail: 99.00,  category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },
      { sku: "23BECMP-2", size: "F",   cost: 40.00, retail: 109.00, category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },
      { sku: "23BECMP-3", size: "Q",   cost: 43.00, retail: 119.00, category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },
      { sku: "23BECMP-4", size: "K",   cost: 50.00, retail: 129.00, category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },
      { sku: "23BECMP-6", size: "TXL", cost: 32.00, retail: 105.00, category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },
      { sku: "23BECMP-7", size: "FXL", cost: 43.00, retail: 119.00, category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },

      { sku: "23BECPP-3", size: "Q", cost: 13.00, retail: 39.00, category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },
      { sku: "23BECPP-4", size: "K", cost: 15.00, retail: 45.00, category: "accessory", brand: "Bloom Essentials", source: "Bloom Essentials" },

      { sku: "23BETMP-1", size: "T",   cost: 37.00, retail: 119.00, category: "accessory", brand: "Bloom Essentials Terry", source: "Bloom Essentials" },
      { sku: "23BETMP-2", size: "F",   cost: 43.00, retail: 139.00, category: "accessory", brand: "Bloom Essentials Terry", source: "Bloom Essentials" },
      { sku: "23BETMP-3", size: "Q",   cost: 51.00, retail: 149.00, category: "accessory", brand: "Bloom Essentials Terry", source: "Bloom Essentials" },
      { sku: "23BETMP-4", size: "K",   cost: 51.00, retail: 179.00, category: "accessory", brand: "Bloom Essentials Terry", source: "Bloom Essentials" },
      { sku: "23BETMP-6", size: "TXL", cost: 40.00, retail: 139.00, category: "accessory", brand: "Bloom Essentials Terry", source: "Bloom Essentials" },

      { sku: "23BESMP-3SQ", size: "SHQ", cost: 35.00, retail: 149.00, category: "accessory", brand: "Bloom Split", source: "Bloom Essentials" },
      { sku: "23BESMP-4SK", size: "SHK", cost: 36.00, retail: 169.00, category: "accessory", brand: "Bloom Split", source: "Bloom Essentials" },

      { sku: "23BEME-1", size: "T",   cost: 48.00, retail: 149.00, category: "accessory", brand: "Bloom Encasement", source: "Bloom Essentials" },
      { sku: "23BEME-2", size: "F",   cost: 56.00, retail: 189.00, category: "accessory", brand: "Bloom Encasement", source: "Bloom Essentials" },
      { sku: "23BEME-3", size: "Q",   cost: 57.00, retail: 199.00, category: "accessory", brand: "Bloom Encasement", source: "Bloom Essentials" },
      { sku: "23BEME-4", size: "K",   cost: 64.00, retail: 209.00, category: "accessory", brand: "Bloom Encasement", source: "Bloom Essentials" },
      { sku: "23BEME-6", size: "TXL", cost: 54.00, retail: 159.00, category: "accessory", brand: "Bloom Encasement", source: "Bloom Essentials" },

      { sku: "23BEBE-1", size: "T",   cost: 42.00, retail: 89.00,  category: "accessory", brand: "Bloom Boxspring", source: "Bloom Essentials" },
      { sku: "23BEBE-2", size: "F",   cost: 51.00, retail: 99.00,  category: "accessory", brand: "Bloom Boxspring", source: "Bloom Essentials" },
      { sku: "23BEBE-3", size: "Q",   cost: 55.00, retail: 109.00, category: "accessory", brand: "Bloom Boxspring", source: "Bloom Essentials" },
      { sku: "23BEBE-6", size: "TXL", cost: 25.00, retail: 90.00,  category: "accessory", brand: "Bloom Boxspring", source: "Bloom Essentials" },

      { sku: "24SGMP-3", size: "Q", cost: 74.00, retail: 169.00, category: "accessory", brand: "Simba Green", source: "Simba Green" },
      { sku: "24SGMP-4", size: "K", cost: 87.00, retail: 199.00, category: "accessory", brand: "Simba Green", source: "Simba Green" },

      { sku: "16CLIMAMP-1", size: "T",   cost: 44.00, retail: 139.00, category: "accessory", brand: "Clima", source: "Clima" },
      { sku: "16CLIMAMP-2", size: "F",   cost: 58.00, retail: 149.00, category: "accessory", brand: "Clima", source: "Clima" },
      { sku: "16CLIMAMP-3", size: "Q",   cost: 64.00, retail: 179.00, category: "accessory", brand: "Clima", source: "Clima" },
      { sku: "16CLIMAMP-4", size: "K",   cost: 81.00, retail: 199.00, category: "accessory", brand: "Clima", source: "Clima" },
      { sku: "16CLIMAMP-6", size: "TXL", cost: 50.00, retail: 179.00, category: "accessory", brand: "Clima", source: "Clima" },
      { sku: "16CLIMAMP-7", size: "FXL", cost: 66.00, retail: 179.00, category: "accessory", brand: "Clima", source: "Clima" },

      { sku: "25HTSMP-1", size: "T",   cost: 62.00, retail: 169.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },
      { sku: "25HTSMP-2", size: "F",   cost: 72.00, retail: 189.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },
      { sku: "25HTSMP-3", size: "Q",   cost: 76.00, retail: 199.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },
      { sku: "25HTSMP-4", size: "K",   cost: 89.00, retail: 229.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },
      { sku: "25HTSMP-6", size: "TXL", cost: 71.00, retail: 189.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },
      { sku: "25HTSMP-3SH", size: "SHQ", cost: 82.00, retail: 219.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },
      { sku: "25HTSMP-4SH", size: "SHK", cost: 97.00, retail: 249.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },

      { sku: "25HTSPP-2", size: "S/Q", cost: 44.00, retail: 99.00,  category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },
      { sku: "25HTSPP-4", size: "K",   cost: 47.00, retail: 119.00, category: "accessory", brand: "Hush Graph-Iced", source: "Hush" },

      { sku: "25HATMP-1", size: "T",   cost: 89.00, retail: 219.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },
      { sku: "25HATMP-2", size: "F",   cost: 93.00, retail: 229.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },
      { sku: "25HATMP-3", size: "Q",   cost: 98.00, retail: 249.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },
      { sku: "25HATMP-4", size: "K",   cost: 113.00, retail: 289.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },
      { sku: "25HATMP-6", size: "TXL", cost: 89.00, retail: 229.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },
      { sku: "25HATMP-3SH", size: "SHQ", cost: 106.00, retail: 269.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },
      { sku: "25HATMP-4SH", size: "SHK", cost: 119.00, retail: 309.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },

      { sku: "25HATPP-2", size: "S/Q", cost: 50.00, retail: 119.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },
      { sku: "25HATPP-4", size: "K",   cost: 52.00, retail: 129.00, category: "accessory", brand: "Hush ArchTech", source: "Hush" },

      { sku: "18PROTEX-1", size: "T",   cost: 82.00, retail: 219.00, category: "accessory", brand: "Tempur-Protex-It", source: "Tempur" },
      { sku: "18PROTEX-2", size: "F",   cost: 86.00, retail: 229.00, category: "accessory", brand: "Tempur-Protex-It", source: "Tempur" },
      { sku: "18PROTEX-3", size: "Q",   cost: 105.00, retail: 249.00, category: "accessory", brand: "Tempur-Protex-It", source: "Tempur" },
      { sku: "18PROTEX-4", size: "K",   cost: 142.00, retail: 289.00, category: "accessory", brand: "Tempur-Protex-It", source: "Tempur" },
      { sku: "18PROTEX-6", size: "TXL", cost: 81.00, retail: 219.00, category: "accessory", brand: "Tempur-Protex-It", source: "Tempur" },

      { sku: "20PURMP-3", size: "Q",   cost: 95.00, retail: 269.00, category: "accessory", brand: "Purple", source: "Purple" },
      { sku: "20PURMP-4", size: "K",   cost: 103.00, retail: 299.00, category: "accessory", brand: "Purple", source: "Purple" },
      { sku: "20PURMP-6", size: "TXL", cost: 76.00, retail: 219.00, category: "accessory", brand: "Purple", source: "Purple" },

      { sku: "25HGIMP-1", size: "T",   cost: 91.00, retail: 249.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },
      { sku: "25HGIMP-2", size: "F",   cost: 102.00, retail: 279.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },
      { sku: "25HGIMP-3", size: "Q",   cost: 108.00, retail: 299.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },
      { sku: "25HGIMP-4", size: "K",   cost: 122.00, retail: 349.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },
      { sku: "25HGIMP-6", size: "TXL", cost: 120.00, retail: 299.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },
      { sku: "25HGIMP-3SH", size: "SHQ", cost: 121.00, retail: 329.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },
      { sku: "25HGIMP-4SH", size: "SHK", cost: 130.00, retail: 369.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },

      { sku: "25HGIPP-2", size: "S/Q", cost: 51.00, retail: 139.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },
      { sku: "25HGIPP-4", size: "K",   cost: 54.00, retail: 149.00, category: "accessory", brand: "Hush Triple-Shield", source: "Hush" },

      { sku: "19PRTCMP-1", size: "T",   cost: 58.00, retail: 149.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },
      { sku: "19PRTCMP-2", size: "F",   cost: 70.00, retail: 169.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },
      { sku: "19PRTCMP-3", size: "Q",   cost: 74.00, retail: 179.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },
      { sku: "19PRTCMP-4", size: "K",   cost: 98.00, retail: 209.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },
      { sku: "19PRTCMP-6", size: "TXL", cost: 57.00, retail: 169.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },
      { sku: "19PRTCMP-3S", size: "SHQ", cost: 76.00, retail: 199.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },

      { sku: "19PRTCTPP-3", size: "Q", cost: 37.00, retail: 100.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },
      { sku: "19PRTCTPP-4", size: "K", cost: 43.00, retail: 110.00, category: "accessory", brand: "Malouf Protect", source: "Malouf" },

      { sku: "19CMFMP-1", size: "T",   cost: 76.00, retail: 199.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },
      { sku: "19CMFMP-2", size: "F",   cost: 77.00, retail: 209.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },
      { sku: "19CMFMP-3", size: "Q",   cost: 82.00, retail: 229.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },
      { sku: "19CMFMP-4", size: "K",   cost: 109.00, retail: 269.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },
      { sku: "19CMFMP-6", size: "TXL", cost: 71.00, retail: 199.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },
      { sku: "19CMFMP-3SQ", size: "SHQ", cost: 98.00, retail: 229.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },
      { sku: "19CMFMP-4SK", size: "SHK", cost: 126.00, retail: 269.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },

      { sku: "19CMFPP-3", size: "Q", cost: 49.00, retail: 110.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },
      { sku: "19CMFPP-4", size: "K", cost: 54.00, retail: 120.00, category: "accessory", brand: "Malouf Comfort", source: "Malouf" },

      { sku: "19RFRSMP-1", size: "T",   cost: 116.00, retail: 229.00, category: "accessory", brand: "Malouf Refresh", source: "Malouf" },
      { sku: "19RFRSMP-2", size: "F",   cost: 131.00, retail: 259.00, category: "accessory", brand: "Malouf Refresh", source: "Malouf" },
      { sku: "19RFRSMP-3", size: "Q",   cost: 140.00, retail: 279.00, category: "accessory", brand: "Malouf Refresh", source: "Malouf" },
      { sku: "19RFRSMP-4", size: "K",   cost: 158.00, retail: 309.00, category: "accessory", brand: "Malouf Refresh", source: "Malouf" },
      { sku: "19RFRSMP-6", size: "TXL", cost: 117.00, retail: 229.00, category: "accessory", brand: "Malouf Refresh", source: "Malouf" },

      { sku: "17ENCAS12-1", size: "T",   cost: 38.00, retail: 149.00, category: "accessory", brand: "Sunset Encasement 12in", source: "Sunset" },
      { sku: "17ENCAS12-2", size: "F",   cost: 45.00, retail: 189.00, category: "accessory", brand: "Sunset Encasement 12in", source: "Sunset" },
      { sku: "17ENCAS12-3", size: "Q",   cost: 48.00, retail: 199.00, category: "accessory", brand: "Sunset Encasement 12in", source: "Sunset" },
      { sku: "17ENCAS12-4", size: "K",   cost: 57.00, retail: 209.00, category: "accessory", brand: "Sunset Encasement 12in", source: "Sunset" },
      { sku: "17ENCAS12-6", size: "TXL", cost: 47.00, retail: 159.00, category: "accessory", brand: "Sunset Encasement 12in", source: "Sunset" },

      { sku: "17ENCAS09-1", size: "T",   cost: 22.00, retail: 89.00, category: "accessory", brand: "Sunset Boxspring 8.5in", source: "Sunset" },
      { sku: "17ENCAS09-2", size: "F",   cost: 25.00, retail: 99.00, category: "accessory", brand: "Sunset Boxspring 8.5in", source: "Sunset" },
      { sku: "17ENCAS09-3", size: "Q",   cost: 30.00, retail: 109.00, category: "accessory", brand: "Sunset Boxspring 8.5in", source: "Sunset" },
      { sku: "17ENCAS09-6", size: "TXL", cost: 22.00, retail: 99.00, category: "accessory", brand: "Sunset Boxspring 8.5in", source: "Sunset" },

      { sku: "19RENEWMP-3", size: "Q",   cost: 96.00, retail: 289.00, category: "accessory", brand: "Malouf Renew", source: "Malouf" },
      { sku: "19RENEWMP-4", size: "K",   cost: 113.00, retail: 309.00, category: "accessory", brand: "Malouf Renew", source: "Malouf" },
      { sku: "19RENEWMP-6", size: "TXL", cost: 80.00, retail: 229.00, category: "accessory", brand: "Malouf Renew", source: "Malouf" },

      { sku: "CLASSMP-1", size: "T",   cost: 32.00, retail: 99.00,  category: "accessory", brand: "Classic Cotton", source: "Classic" },
      { sku: "CLASSMP-2", size: "F",   cost: 40.00, retail: 109.00, category: "accessory", brand: "Classic Cotton", source: "Classic" }
    ];

    const PROTECTION_PLANS = {
      good: [
        { sku: "23BECMP-3" }, // Bloom Essentials Q protector
        { sku: "23BEBE-3" },  // Bloom Boxspring Q
        { manual: {
            size: "Q",
            brand: "Extend",
            note: "Extend ‚Äì Standard",
            category: "extend",
            retail: 299.00,
            cost: 0.00
        } }
      ],
      better: [
        { sku: "16CLIMAMP-3" }, // Clima Q
        { sku: "25HTSMP-3" },   // Hush Graph-Iced Q
        { manual: {
            size: "Q",
            brand: "Extend",
            note: "Extend ‚Äì Plus",
            category: "extend",
            retail: 349.00,
            cost: 0.00
        } }
      ],
      best: [
        { sku: "25HGIMP-3" }, // Hush Triple-Shield Q
        { sku: "25HATMP-3" }, // Hush ArchTech Q
        { manual: {
            size: "Q",
            brand: "Extend",
            note: "Extend ‚Äì Premium",
            category: "extend",
            retail: 399.00,
            cost: 0.00
        } }
      ]
    };

    function formatMoney(v) {
      const n = Number(v) || 0;
      return "$" + n.toFixed(2);
    }

    function getCategoryOptionsHtml(selected) {
      const cats = [
        { value: "", label: "Select‚Ä¶" },
        { value: "mattress", label: "Mattress" },
        { value: "extend", label: "Extend" },
        { value: "accessory", label: "Accessory" },
        { value: "other", label: "Other" }
      ];
      return cats.map(c => (
        '<option value="' + c.value + '"' +
        (c.value === (selected || "") ? " selected" : "") +
        '>' + c.label + '</option>'
      )).join("");
    }

    function addRow(prefillItem) {
      const tbody = document.querySelector("#bundle-table tbody");
      const tr = document.createElement("tr");

      // SKU
      const tdSku = document.createElement("td");
      const skuSelect = document.createElement("select");
      let skuOptions = '<option value="">-- blank --</option>';
      CATALOG.forEach(item => {
        skuOptions += '<option value="' + item.sku + '">' + item.sku + '</option>';
      });
      skuSelect.innerHTML = skuOptions;
      tdSku.appendChild(skuSelect);

      // Size
      const tdSize = document.createElement("td");
      const sizeInput = document.createElement("input");
      sizeInput.type = "text";
      tdSize.appendChild(sizeInput);

      // Brand
      const tdBrand = document.createElement("td");
      const brandInput = document.createElement("input");
      brandInput.type = "text";
      tdBrand.appendChild(brandInput);

      // Note
      const tdNote = document.createElement("td");
      const noteInput = document.createElement("input");
      noteInput.type = "text";
      tdNote.appendChild(noteInput);

      // Category
      const tdCat = document.createElement("td");
      const catSelect = document.createElement("select");
      catSelect.innerHTML = getCategoryOptionsHtml("");
      tdCat.appendChild(catSelect);

      // Retail
      const tdRetail = document.createElement("td");
      const retailInput = document.createElement("input");
      retailInput.type = "number";
      retailInput.step = "0.01";
      tdRetail.appendChild(retailInput);

      // Deal %
      const tdDeal = document.createElement("td");
      const dealInput = document.createElement("input");
      dealInput.type = "number";
      dealInput.step = "0.1";
      tdDeal.appendChild(dealInput);

      // Selling
      const tdSelling = document.createElement("td");
      const sellingInput = document.createElement("input");
      sellingInput.type = "number";
      sellingInput.step = "0.01";
      tdSelling.appendChild(sellingInput);

      // Cost
      const tdCost = document.createElement("td");
      const costInput = document.createElement("input");
      costInput.type = "number";
      costInput.step = "0.01";
      tdCost.appendChild(costInput);

      // GP $
      const tdGp = document.createElement("td");
      const gpInput = document.createElement("input");
      gpInput.type = "number";
      gpInput.readOnly = true;
      tdGp.appendChild(gpInput);

      // GP %
      const tdGpPct = document.createElement("td");
      const gpPctInput = document.createElement("input");
      gpPctInput.type = "text";
      gpPctInput.readOnly = true;
      tdGpPct.appendChild(gpPctInput);

      // Comm
      const tdComm = document.createElement("td");
      const commInput = document.createElement("input");
      commInput.type = "number";
      commInput.readOnly = true;
      tdComm.appendChild(commInput);

      // Remove button
      const tdRemove = document.createElement("td");
      const rmBtn = document.createElement("button");
      rmBtn.type = "button";
      rmBtn.className = "btn btn-danger";
      rmBtn.textContent = "√ó";
      rmBtn.style.padding = "2px 6px";
      rmBtn.onclick = () => {
        tr.remove();
        updateSummary();
      };
      tdRemove.appendChild(rmBtn);

      // Append cells
      tr.appendChild(tdSku);
      tr.appendChild(tdSize);
      tr.appendChild(tdBrand);
      tr.appendChild(tdNote);
      tr.appendChild(tdCat);
      tr.appendChild(tdRetail);
      tr.appendChild(tdDeal);
      tr.appendChild(tdSelling);
      tr.appendChild(tdCost);
      tr.appendChild(tdGp);
      tr.appendChild(tdGpPct);
      tr.appendChild(tdComm);
      tr.appendChild(tdRemove);

      tbody.appendChild(tr);

      function updateRowCalc() {
        const retail = parseFloat(retailInput.value) || 0;
        const selling = parseFloat(sellingInput.value) || 0;
        const cost = parseFloat(costInput.value) || 0;

        const gp = selling - cost;
        gpInput.value = gp ? gp.toFixed(2) : "";

        let gpPct = 0;
        if (selling > 0 && gp !== 0) {
          gpPct = (gp / selling) * 100;
        }
        gpPctInput.value = selling ? gpPct.toFixed(1) + "%" : "";

        const cat = catSelect.value || "other";
        const rate = COMM_RATES[cat] || 0;
        const comm = selling * rate;
        commInput.value = comm ? comm.toFixed(2) : "";

        updateSummary();
      }

      skuSelect.addEventListener("change", () => {
        const sku = skuSelect.value;
        const item = CATALOG.find(x => x.sku === sku);
        if (item) {
          sizeInput.value = item.size;
          brandInput.value = item.brand;
          noteInput.value = item.source;
          catSelect.value = item.category || "accessory";
          retailInput.value = item.retail.toFixed(2);
          costInput.value = item.cost.toFixed(2);
          dealInput.value = "0";
          sellingInput.value = item.retail.toFixed(2);
        }
        updateRowCalc();
      });

      retailInput.addEventListener("input", () => {
        const retail = parseFloat(retailInput.value) || 0;
        const deal = parseFloat(dealInput.value) || 0;
        const selling = retail * (1 - (deal / 100));
        sellingInput.value = retail ? selling.toFixed(2) : "";
        updateRowCalc();
      });

      dealInput.addEventListener("input", () => {
        const retail = parseFloat(retailInput.value) || 0;
        const deal = parseFloat(dealInput.value) || 0;
        const selling = retail * (1 - (deal / 100));
        sellingInput.value = retail ? selling.toFixed(2) : "";
        updateRowCalc();
      });

      sellingInput.addEventListener("input", () => {
        const retail = parseFloat(retailInput.value) || 0;
        const selling = parseFloat(sellingInput.value) || 0;
        if (retail > 0 && selling > 0) {
          const dealPct = (1 - (selling / retail)) * 100;
          dealInput.value = dealPct.toFixed(1);
        } else {
          dealInput.value = "";
        }
        updateRowCalc();
      });

      costInput.addEventListener("input", updateRowCalc);
      catSelect.addEventListener("change", updateRowCalc);

      // Prefill if needed
      if (prefillItem && prefillItem.sku) {
        skuSelect.value = prefillItem.sku;
        sizeInput.value = prefillItem.size || "";
        brandInput.value = prefillItem.brand || "";
        noteInput.value = prefillItem.source || "";
        catSelect.value = prefillItem.category || "accessory";
        retailInput.value = prefillItem.retail.toFixed(2);
        costInput.value = prefillItem.cost.toFixed(2);
        dealInput.value = "0";
        sellingInput.value = prefillItem.retail.toFixed(2);
        updateRowCalc();
      } else if (prefillItem && prefillItem.manual) {
        const m = prefillItem.manual;
        sizeInput.value = m.size || "";
        brandInput.value = m.brand || "";
        noteInput.value = m.note || "";
        catSelect.value = m.category || "extend";
        retailInput.value = (m.retail || 0).toFixed(2);
        costInput.value = (m.cost || 0).toFixed(2);
        dealInput.value = "0";
        sellingInput.value = (m.retail || 0).toFixed(2);
        updateRowCalc();
      }

      return tr;
    }

    function clearAll() {
      const tbody = document.querySelector("#bundle-table tbody");
      tbody.innerHTML = "";
      addRow(); // first line empty
      updateSummary();
      refreshCustomerView();
    }

    function updateSummary() {
      const tbody = document.querySelector("#bundle-table tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      let totalSelling = 0;
      let totalCost = 0;
      let totalGp = 0;
      let totalComm = 0;
      let mattressExtendSelling = 0;
      let accessoriesSelling = 0;

      rows.forEach(row => {
        const tds = row.querySelectorAll("td");
        if (!tds.length) return;

        const catSelect = tds[4].querySelector("select");
        const cat = catSelect ? (catSelect.value || "other") : "other";

        const sellingInput = tds[7].querySelector("input");
        const costInput = tds[8].querySelector("input");
        const commInput = tds[11].querySelector("input");

        const selling = parseFloat(sellingInput && sellingInput.value) || 0;
        const cost = parseFloat(costInput && costInput.value) || 0;
        const comm = parseFloat(commInput && commInput.value) || 0;
        const gp = selling - cost;

        totalSelling += selling;
        totalCost += cost;
        totalGp += gp;
        totalComm += comm;

        if (cat === "mattress" || cat === "extend") {
          mattressExtendSelling += selling;
        } else if (cat === "accessory") {
          accessoriesSelling += selling;
        }
      });

      const sumSellingEl = document.getElementById("sum-selling");
      const sumCostEl = document.getElementById("sum-cost");
      const sumGpEl = document.getElementById("sum-gp");
      const sumGpPctEl = document.getElementById("sum-gp-percent");
      const sumCommEl = document.getElementById("sum-comm");
      const sumCommPer100El = document.getElementById("sum-comm-per-100");
      const sumMattressExtendEl = document.getElementById("sum-mattress-extend");
      const sumAccessoriesEl = document.getElementById("sum-accessories");

      if (sumSellingEl) sumSellingEl.textContent = formatMoney(totalSelling);
      if (sumCostEl) sumCostEl.textContent = formatMoney(totalCost);
      if (sumGpEl) sumGpEl.textContent = formatMoney(totalGp);

      let gpPct = 0;
      if (totalSelling > 0 && totalGp !== 0) {
        gpPct = (totalGp / totalSelling) * 100;
      }
      if (sumGpPctEl) sumGpPctEl.textContent = totalSelling ? gpPct.toFixed(1) + "%" : "0.0%";

      if (sumCommEl) sumCommEl.textContent = formatMoney(totalComm);

      const commPer100 = totalSelling > 0 ? totalComm / (totalSelling / 100) : 0;
      if (sumCommPer100El) sumCommPer100El.textContent = totalSelling ? formatMoney(commPer100) : "$0.00";

      if (sumMattressExtendEl) sumMattressExtendEl.textContent = formatMoney(mattressExtendSelling);
      if (sumAccessoriesEl) sumAccessoriesEl.textContent = formatMoney(accessoriesSelling);
    }

    function renderCatalogSearch() {
      const term = (document.getElementById("catalog-search-input").value || "").trim().toLowerCase();
      const tbody = document.getElementById("catalog-search-results");
      if (!tbody) return;
      tbody.innerHTML = "";

      let results = CATALOG.filter(item => {
        const haystack = (item.sku + " " + item.size + " " + item.brand + " " + item.source).toLowerCase();
        if (!term) return true;
        return haystack.includes(term);
      });

      results = results.slice(0, 50);

      if (!results.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.textContent = "No matches found. Try a different SKU, brand or size.";
        td.style.fontSize = "11px";
        td.style.color = "#777";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      results.forEach(item => {
        const tr = document.createElement("tr");

        const tdSku = document.createElement("td");
        tdSku.textContent = item.sku;

        const tdSize = document.createElement("td");
        tdSize.textContent = item.size;

        const tdBrand = document.createElement("td");
        tdBrand.textContent = item.brand;

        const tdSource = document.createElement("td");
        tdSource.textContent = item.source;

        const tdRetail = document.createElement("td");
        tdRetail.textContent = item.retail.toFixed(2);

        const tdCost = document.createElement("td");
        tdCost.textContent = item.cost.toFixed(2);

        const tdAction = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-primary";
        btn.textContent = "Add";
        btn.style.fontSize = "10px";
        btn.style.padding = "3px 8px";
        btn.onclick = () => {
          addRow(item);
          const table = document.getElementById("bundle-table");
          if (table) {
            const rect = table.getBoundingClientRect();
            const scrollTop = window.scrollY + rect.top - 80;
            window.scrollTo({ top: scrollTop, behavior: "smooth" });
          }
        };
        tdAction.appendChild(btn);

        tr.appendChild(tdSku);
        tr.appendChild(tdSize);
        tr.appendChild(tdBrand);
        tr.appendChild(tdSource);
        tr.appendChild(tdRetail);
        tr.appendChild(tdCost);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    function openProtectionPlans() {
      const overlay = document.getElementById("protection-overlay");
      if (overlay) overlay.style.display = "flex";
    }

    function closeProtectionPlans() {
      const overlay = document.getElementById("protection-overlay");
      if (overlay) overlay.style.display = "none";
    }

    function applyPlan(planKey) {
      const plan = PROTECTION_PLANS[planKey];
      if (!plan) return;
      clearAll();
      plan.forEach(piece => {
        if (piece.sku) {
          const item = CATALOG.find(x => x.sku === piece.sku);
          if (item) addRow(item);
        } else if (piece.manual) {
          addRow({ manual: piece.manual });
        }
      });
      updateSummary();
      refreshCustomerView();
      closeProtectionPlans();
    }

    function refreshCustomerView() {
      const box = document.getElementById("customer-summary-box");
      if (!box) return;

      const tbody = document.querySelector("#bundle-table tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      let lines = [];
      let totalSelling = 0;

      rows.forEach(row => {
        const tds = row.querySelectorAll("td");
        if (!tds.length) return;

        const sizeInput = tds[1].querySelector("input");
        const brandInput = tds[2].querySelector("input");
        const noteInput = tds[3].querySelector("input");
        const dealInput = tds[6].querySelector("input");
        const sellingInput = tds[7].querySelector("input");

        const size = (sizeInput && sizeInput.value || "").trim();
        const brand = (brandInput && brandInput.value || "").trim();
        const note = (noteInput && noteInput.value || "").trim();
        const deal = parseFloat(dealInput && dealInput.value) || 0;
        const selling = parseFloat(sellingInput && sellingInput.value) || 0;

        if (selling <= 0) return;

        totalSelling += selling;

        const parts = [];
        if (size) parts.push(size);
        if (brand) parts.push(brand);

        let label = parts.join(" ");
        if (note) {
          label += (label ? " ‚Äì " : "") + note;
        }
        if (!label) label = "Item";

        let dealText = "no discount";
        if (deal > 0) {
          const d = deal.toFixed(1).replace(/\.0$/, "");
          dealText = d + "% off";
        }

        lines.push(`‚Ä¢ ${label}: ${formatMoney(selling)} (${dealText})`);
      });

      if (!lines.length) {
        box.textContent = 'No priced items yet ‚Äì build a bundle above, then tap ‚ÄúGenerate customer summary‚Äù.';
        return;
      }

      const totalLine = `\nBundle total: ${formatMoney(totalSelling)} (tax extra).`;
      const closing = "\nThis is a custom bundle built for you today. Final discount and availability are subject to manager approval.";

      box.textContent = lines.join("\n") + totalLine + closing;
    }

    function generateCouponCode() {
      const el = document.getElementById("coupon-code-display");
      if (!el) return;
      const now = new Date();
      const yy = String(now.getFullYear()).slice(-2);
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      const rand = Math.floor(100 + Math.random() * 900);
      const code = "GTA-" + yy + mm + dd + "-" + rand;
      el.textContent = code;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(code);
        }
      } catch (e) {
        // ignore clipboard errors
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      addRow();           // first empty line
      renderCatalogSearch();
      updateSummary();
      refreshCustomerView();

      const overlay = document.getElementById("protection-overlay");
      if (overlay) {
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) {
            closeProtectionPlans();
          }
        });
      }
    });
  </script>
</body>
</html>
